<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medidor de gas - web server</title>

    <link rel="stylesheet" href="styles.css" />

    <!-- <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script> -->

    <script src="src/jquery-3.6.4.min.js"></script>
    <script src="src/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="src/bootstrap.min.css" />

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar fixed-top navbar-expand-sm navbar-dark bg-dark pt-2 pb-2">
      <div class="container-fluid">
        <a class="navbar-brand"> <h2 class="nav-titulo">Medidor de gas</h2></a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link active" href="index.html">Inicio</a>
            <a class="nav-link" href="index.html">Historial</a>
            <a class="nav-link" href="index.html">Configuración</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="container nav_sep">
      <div><h2>Estado</h2></div>
      <dir class="row">
        <div class="col-md-6 col-sm-12" id="estado">
          <div class="col">
            <div class="txtEstado" id="medicion">En linea</div>
            <div class="txtEstado" id="capacidad">Capacidad: 10Kg</div>
            <div class="txtEstado" id="fecha-inicio">Puesta en linea: 25/3/2023 16:45:50</div>
            <div class="txtEstado" id="en-linea">59 días 15:45:20</div>
            <div class="txtEstado" id="consumido">Gas consumido: 8.10 Kg</div>
            <div class="txtEstado" id="temperatura">Temperatura: 25.9°C</div>
            <div class="txtEstado" id="presion">Presión: 1012.89 hPa</div>
          </div>
          <div class="row">
            <div class="col mt-1">
              <button type="button" class="btn btn-primary w-100" id="btnMedicion">Detener</button>
            </div>
            <div class="col mt-1">
              <button type="button" class="btn btn-primary w-100" id="btnCambiar">Cambiar</button>
            </div>
            <div class="col mt-1">
              <button type="button" class="btn btn-primary w-100" id="btnEditar" data-bs-toggle="offcanvas" data-bs-target="#formEdit" aria-controls="formEdit">
                Editar
              </button>
            </div>
            <div class="col mt-1 d-none">
              <button type="button" class="btn btn-primary w-100" id="btnTara">Poner a 0</button>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-sm-12 d-flex flex-column align-items-center">
          <div class="w-100 h-100" id="grafico"></div>
        </div>
      </dir>
      <hr />

      <!-- Seccion de listado de historial de garrafas -->
      <div class="row mt-2">
        <h2>Historial de cambio de garrafas</h2>
        <div>
          <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
              <button
                class="nav-link active"
                id="nav-grafico-tab"
                data-bs-toggle="tab"
                data-bs-target="#nav-grafico"
                type="button"
                role="tab"
                aria-controls="nav-grafico"
                aria-selected="true"
              >
                Gráfico
              </button>
              <button
                class="nav-link"
                id="nav-lista-tab"
                data-bs-toggle="tab"
                data-bs-target="#nav-lista"
                type="button"
                role="tab"
                aria-controls="nav-lista"
                aria-selected="false"
              >
                Listado
              </button>
            </div>
          </nav>
          <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-grafico" role="tabpanel" aria-labelledby="nav-grafico-tab" tabindex="0">
              <div class="row mt-2">
                <!-- Tab con el historial en forma de grafico -->
                <div id="historial"></div>
              </div>
            </div>
            <!-- Tab con el historial en forma de lista -->
            <div class="tab-pane fade" id="nav-lista" role="tabpanel" aria-labelledby="nav-lista-tab" tabindex="0">
              <div>Lista de garrafas</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Offcanvas para editar los datos de las garrafas -->

      <div class="offcanvas offcanvas-end text-bg-dark" data-bs-backdrop="static" tabindex="-1" id="formEdit" aria-labelledby="formEditLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="formEditLabel">Editar información de garrafa</h5>
          <button type="button" class="btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
          <div class="text-center"><h5>Datos de garrafa</h5></div>
          <div>
            <label for="inputCapacidad" class="form-label">Capacidad de garrafa (Kg)</label>
            <input type="number" class="form-control" id="inputCapacidad" min="1" max="100" placeholder="10.00" step="0.01" />
          </div>
          <div>
            <label for="inputTara" class="form-label">Tara de garrafa (Kg)</label>
            <input type="number" class="form-control" id="inputTara" min="1" max="100" placeholder="13.00" step="0.01" />
          </div>
          <div>
            <div class="form-label mt-2">Metodo de medición</div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="inputMetodo" id="inputMetodoTara" />
              <label class="form-check-label" for="inputMetodoTara"> Por tara de garrafa</label>
            </div>
            <div class="form-check">
              <input class="form-check-input ps-2" type="radio" name="inputMetodo" id="inputMetodoPesoInicial" checked />
              <label class="form-check-label" for="inputMetodoPesoInicial"> Por peso inicial de garrafa </label>
            </div>
          </div>
          <hr />
          <div class="text-center"><h5>Condiciones al inicio</h5></div>
          <div>
            <label for="inputInicioBruto" class="form-label">Peso bruto de la garrafa (Kg)</label>
            <input type="number" class="form-control" id="inputInicioBruto" min="1" max="100" placeholder="23.00" step="0.01" />
          </div>
          <div>
            <label for="inputInicioDate" class="form-label">Fecha y hora de inicio</label>
            <input type="datetime-local" class="form-control" id="inputInicioDate" name="inputInicioDate" />
          </div>
          <hr />
          <div class="text-center"><h5>Condiciones al final</h5></div>
          <div>
            <label for="inputFinBruto" class="form-label">Peso bruto de la garrafa (Kg)</label>
            <input type="number" class="form-control" id="inputFinBruto" min="1" max="100" placeholder="13.30" step="0.01" />
          </div>
          <div>
            <label for="inputInicioDate" class="form-label">Fecha y hora de final</label>
            <input type="datetime-local" class="form-control" id="inputFinDate" name="inputFinDate" />
          </div>
          <hr />
          <div>
            <div class="row">
              <div class="col"><button type="button" class="btn btn-primary w-100" id="btnEditCancelar">Cancelar</button></div>
              <div class="col"><button type="button" class="btn btn-primary w-100" id="btnEditGuardar">Guardar</button></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
    google.charts.load("current", { packages: ["gauge", "timeline"] });
    google.charts.setOnLoadCallback(function () {
      drawGauge();
      drawHistorial();
    });

    function drawGauge(status) {
      if (status == null) status = { disponible: 0.0 };

      let grafico = google.visualization.arrayToDataTable([
        ["Label", "Value"],
        ["Disponible", status.disponible],
      ]);

      let options = {
        redFrom: 0,
        redTo: 1.0,
        yellowFrom: 1.0,
        yellowTo: 2.5,
        greenFrom: 2.5,
        yellowTo: 2.5,
        greenTo: 10,
        min: 0,
        max: 10.0,
      };

      let chart = new google.visualization.Gauge(document.getElementById("grafico"));
      chart.draw(grafico, options);
    }

    function drawHistorial(historial) {
      // if (status == null) status = { disponible: 0.0 };
      let chart = new google.visualization.Timeline(document.getElementById("historial"));
      let dataTable = new google.visualization.DataTable();

      dataTable.addColumn({ type: "string", id: "Garrafa" });
      dataTable.addColumn({ type: "date", id: "Start" });
      dataTable.addColumn({ type: "date", id: "End" });

      if (historial == null) {
        dataTable.addRows([
          ["1", new Date(1789, 3, 30), new Date(1797, 2, 4)],
          ["2", new Date(1797, 2, 4), new Date(1801, 2, 4)],
          ["3", new Date(1801, 2, 4), new Date(1809, 2, 4)],
        ]);
      } else {
        console.log(historial);
        let rows = [];
        historial.forEach((element) => {
          let inicio = new Date(element.inicio.date);
          let fin = new Date(element.fin.date);
          if (fin < inicio) fin = new Date(Date.now()); //Sumar un día
          rows.push(["garrafa", inicio, fin]);
        });
        dataTable.addRows(rows);
      }

      chart.draw(dataTable);
    }

    function updateHistorial() {
      $.ajax({ method: "GET", url: "http://192.168.1.57/historial?page=0" }).done(function (historial) {
        console.log(historial);
        drawHistorial(historial);
      });
    }

    function updateStatus() {
      $.ajax({ method: "GET", url: "http://192.168.1.57/status" }).done(function (status) {
        console.log(status);

        $("#medicion").text(status.estado === "online" ? "En linea" : "Medición pausada");
        $("#capacidad").text("Capacidad garrafa: " + status.capacidad.toFixed(2) + " Kg");
        $("#fecha-inicio").text("Fecha de cambio: ");
        $("#en-linea").text("Tiempo en uso: " + status.online);
        $("#consumido").text("Gas consumido: " + status.consumido.toFixed(2) + " Kg");
        $("#temperatura").text("Temperatura: " + status.temp.toFixed(2) + " °C");
        $("#presion").text("Presión: " + status.presion.toFixed(2) + " hPa");

        $("#disponible").text("Gas disponible: " + status.disponible + " Kg");
        $("#porc").text("Capacidad garrafa: " + status.cons_porc + " %");
        drawGauge(status);

        updateBtnMedicion(status);
      });
    }

    function updateBtnMedicion(status) {
      $("#btnMedicion").text(status.estado === "online" ? "Detener" : "Iniciar");
    }

    function loadEditInfo(info) {
      $("#inputCapacidad").val(info.capacidad.toFixed(2));
      $("#inputTara").val(info.tara.toFixed(2));
      $("#inputMetodoTara").prop("checked", info.metodo == "por tara");
      $("#inputMetodoPesoInicial").prop("checked", info.metodo == "por peso inicial");
      $("#inputInicioBruto").val(info.inicio.bruto.toFixed(3));
      console.log(info.inicio.date);
      console.log(new Date(info.inicio.date).toISOString());
      console.log(new Date(info.inicio.date).toISOString().slice(0, 19));
      console.log(new Date(info.inicio.date).toJSON().slice(0, 19));
      $("#inputInicioDate").val(new Date(info.inicio.date).toISOString().slice(0, 19));
      $("#inputFinBruto").val(info.fin.bruto.toFixed(3));
      $("#inputFinDate").val(new Date(info.fin.date).toISOString().slice(0, 19));
    }

    $(document).ready(function () {
      updateStatus();
      updateHistorial();

      setInterval(updateStatus, 2500);

      $("#btnMedicion").click(function () {
        $("#btnMedicion").html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
        if ($("#btnMedicion").text() == "Detener") {
          $.ajax({ method: "GET", url: "http://192.168.1.57/detener" }).done(function (status) {
            updateStatus();
          });
        } else {
          $.ajax({ method: "GET", url: "http://192.168.1.57/iniciar" }).done(function (status) {
            updateStatus();
          });
        }
      });

      $("#btnEditar").click(function () {
        $.ajax({ method: "GET", url: "http://192.168.1.57/info" }).done(function (info) {
          loadEditInfo(info);
        });
      });
    });
  </script>
</html>
